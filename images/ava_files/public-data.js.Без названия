define(["require","jquery","underscore","plugin-dependencies","common/datastore/collabservice/api/links/read","common/datastore/sharedcloud/assets/read","common/utils/sharedcloud","common/datastore/ccstorage/api/resolve/exists","common/datastore/ccstorage/utils"],function(e,o,n,r,t,i,a,d,c){"use strict";var s=/\/link\/([a-z0-9\-]+)(?:[\?#].*)?$/i,l=function(){var n={"application/vnd.adobe.sketch.project+dcx":["./models/adobesketch"],"application/vnd.adobe.draw.project+dcx":["./models/adobedraw"],"application/vnd.adobe.photoshop-mix.composition+dcx":["./models/adobe-psmix"],"application/vnd.adobe.photoshop-fix.composition+dcx":["./models/adobe-psfix"],"application/vnd.adobe.line.sketchbook+dcx":["./models/adobe-line"],"application/vnd.adobe.layup.project+dcx":["./models/adobe-layup"],"application/vnd.adobe.comp.project+dcx":["./models/adobe-layup"],"application/vnd.adobe.clip.project+dcx":["./models/adobe-premiereclip"]};return function(r){var t=n[r],i=o.Deferred();return t?e(t,i.resolve,i.reject):i.reject("Unknown mimetype "+r),i.promise()}}(),u={},p={getProject:function(){var e=o.Deferred(),r=s.exec(window.location.href);return r&&r[1]?t.read(r[1],"manifest,ownerId").then(function(e){return o.when(l(e.resourceType),e)}).then(function(o,r){var t=u[r.url]||o().init();t.type=r.resourceType,n.extend(t.location,c.url(r.dcxUrl)),u[r.url]=t,e.resolve(t,r)}).fail(e.reject):e.reject("invalid url"),e.promise()},getAsset:function(){var e=(o.Deferred(),s.exec(window.location.href));return e&&e[1]?t.read(e[1],"manifest,ownerId").then(function(e){if(e.manifest)return o.Deferred().resolve(e.manifest);var r=n(e.resources).findWhere({name:"manifest"});return r?i.read(r.url,"json"):o.Deferred().reject("Could not find manifest.json in link metadata")}):o.Deferred().reject("invalid url")},wipeAsset:function(){},getRendition:function(e,r,t,i,a,d,c){var s=o.Deferred(),l=function(){o("<img>").attr("src","/resource/img/defaults/tile/unknown.png").load(function(){s.resolve(o(this),this.naturalWidth,this.naturalHeight,!0)})};return c?l():p.getProject().then(function(e,t){var i=r.split("/").pop(),a=t.resources[0].name?{name:i}:{componentID:i},d=n.findWhere(t.resources,a);d?o("<img>").attr("src",d.renditions[1200]).error(n.once(l)).load(function(){s.resolve(o(this),this.naturalWidth,this.naturalHeight)}):l()}).fail(l),s.promise()},getRenditionUrl:function(){},url:function(){return{isPublicLink:!0}}};return p});