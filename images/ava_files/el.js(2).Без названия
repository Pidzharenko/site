define(["jquery","underscore","plugin-dependencies","common/utils/templates","common/utils/mimetypes","plugins/ccweb.collections.libraries/data","plugins/ccweb.collections.libraries/config","common/datastore/collabservice/api/collaboration/read","text!./template.html","text!./item.html","text!./collab.html","text!./subscribe.html","css!./template.css"],function(e,i,t,a,n,l,r,o,s,d,c,m){s=a.createTemplate(s),d=a.createTemplate(d),c=a.createTemplate(c),m=a.createTemplate(m);var g=function(i){t.log()("ets",{code:"CC_RECENTS_USAGE",sub_code:"LIBRARIES_CLICK"}),t.router.navigate("/assets/libraries/"+e(i.currentTarget).data("library"),{trigger:!0})},u=function(e,i){e.find(".stellar-DesignLibraries-image").addClass("stellar-DesignLibraries-imageNoRendition"),e.find(".stellar-DesignLibraries-image").addClass(n.libraries[i]||"image")};return function(a){var n=e(s({translate:t.translate})),b=function(e,i){var t="assets/adobe-libraries/"+i;o.off(t,p).on(t,p).read(t)},p=function(e){var i=e.rootUrl.split("/"),t=i[i.length-1],a=n.find('li[data-library="'+t+'"]'),l=e.collaborators.length+e.invites.length,r=a.find(".inline-collab-indicator");return 2>l?void r.remove():void r.text(l)},f=function(){for(var i=200,t=20,a=e(".stellar-DesignLibraries-list").width(),l=0;a>l;)l+=200+1.2*t;var r=Math.min(a/l,1),o=Math.floor(i*r);n.css("height",o),n.find(".stellar-DesignLibraries-asset").css({width:o,height:o})};return i.each(a,function(a,o){if(6>o){var s=e(d({id:a.id,title:t.utils.htmlEncode(a.name)}));n.find("ul").append(s).hide().fadeIn(500);var p=a.getFilteredElements("application/vnd.adobe.element.image+dcx"),f=a.getFilteredElements("application/vnd.adobe.element.look+dcx"),h=a.getFilteredElements("application/vnd.adobe.element.video+dcx"),v=a.getFilteredElements("application/vnd.adobe.element.3d+dcx"),x=a.getFilteredElements("application/vnd.adobe.element.pattern+dcx");p=p.concat(f,h,v,x);var L=p.length?i.max(p,function(e){return e.modified}):null,y=i.groupBy(a.elements,"type"),E=i.max(y,function(e){return e.length}),_=E&&E.length?E[0].type:"";if(L?L.getThumbnailURL(r.imgsize,function(e,i){e?u(s,_):(i=r.imgtype(L,i),l.loadRendition(i).done(function(){s.find(".stellar-DesignLibraries-image").css({"background-image":"url("+i+")"}).hide().fadeIn(500)}))}):u(s,_),t.utils.hasFeature("temp_new_send_link_dialog")){var D=a._bookmarkID;D&&s.find(".stellar-DesignLibraries-title").append(m)}void 0!==a.collaboration&&t.utils.hasFeature("dl_collaboration")&&(s.find(".stellar-DesignLibraries-title").append(c),b(s,a.id));var k=n.find('li[data-library="'+a.id+'"]');k.off("click",g).on("click",g)}}),e(window).on("resize",f),i.delay(f,0),n}});