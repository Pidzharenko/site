define(["jquery","underscore","utils","plugin-dependencies","common/utils/templates","common/images/load","common/utils/file","text!./template.html","text!./asset.html","text!./folder.html","css!./template.css"],function(e,t,i,a,l,o,n,r,d,s){d=l.createTemplate(d),s=l.createTemplate(s);var c=function(e,t){var i={id:e.id,name:e.name,height:250,type:e.mimeType};return o(i,t)};return function(i){var l=e(r),o=!1,h=function(){var a=200,l=20,o=e(".stellar-Files-list").width(),n=(e(".stellar-Files-list").height(),[]);t.each(i,function(e){var t=e._width||400,i=e._height||300,l="file";e._isSharedRoot||e._isMount?l="collabFolder":e._isFolder&&(l="folder");var o=Math.min(Math.floor(t*(a/i)),350);n.push({width:o,height:0,originalWidth:t,originalHeight:i,id:e.id,name:e.name,type:l,location:e._isMount?e._mountTarget:e.location,mimeType:e.type,tags:e.tags})});for(var r=0,d=0;o>d&&!(r>=n.length);){var s=n[r++].width+1.3*l;d+=s}for(var c=Math.min(o/d,1),h=Math.floor(a*c),g=0,m=[];r>g;){var u=Math.floor(n[g].width*c),f={width:u,height:h,originalWidth:n[g].originalWidth,originalHeight:n[g].originalHeight,id:n[g].id,name:n[g].name,type:n[g].type,location:n[g].location,mimeType:n[g].mimeType,tags:n[g].tags};m.push(f),g++}return m},g=function(i){e(window).off("resize",t.throttle(m,100));var l=e(i.currentTarget).attr("data-file"),o=l.indexOf("collections")>-1||l.indexOf("mounts")>-1?"files":"file";a.log()("ets",{code:"CC_RECENTS_USAGE",sub_code:"FILES_CLICK"}),a.router.navigate("/"+o+"?location="+encodeURIComponent(l),{trigger:!0,replace:!1})},m=function(){var a=h(),r=l.find(".stellar-Files-list");r.empty();var m;t.each(a,function(t,a){var h=n.hasTag(t,"creative_cloud/marketing_cloud_collab"),f=i[a].xdFolder;"folder"!==t.type&&"collabFolder"!==t.type||f?(r.append(d({id:t.id,title:t.name,width:t.width+"px",height:t.height+"px"})),m=l.find('[data-file="'+t.id+'"]'),o||m.hide().fadeIn(500),m.click(g),f&&(t=i[a],t.mimeType="application/vnd.adobe.sparkler.project+dcx"),c(t,function(i){var a=e('[data-file="'+t.id+'"] .stellar-Files-image');a.css("background-image","url("+i[0].src+")"),t.originalWidth<t.width||t.originalHeight<t.height?a.css("background-size","auto"):f&&a.css("background-size","75%")})):(r.append(s({id:t.id,title:t.name,width:t.width+"px",height:t.height+"px",marketingBadge:h?"marketing-cloud-collab":""})),m=l.find('[data-file="'+t.id+'"]'),o||m.hide().fadeIn(500),m.click(g),"collabFolder"===t.type&&(u(t.location,m),m.find(".stellar-Files-badges").removeClass("stellar-Files-badgesHidden")))}),o=!0},u=function(e,t){require(["files/dataStoreSharedCloud"],function(i){i.fetchCollaborationData(e).then(function(e){var i=e.collaboratorCount,a=i>1;t.find(".stellar-Files-badgeCount span").text(a?i:"")})})};return t.delay(m,0),e(window).on("resize",t.throttle(m,100)),l}});