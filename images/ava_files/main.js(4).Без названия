define(["jquery","common/utils/log","plugin-dependencies","common/utils/path","plugin-components/image-loader","plugin-components/preview-menu/view","text!./main.html","css!./main.css"],function(e,i,t,o,n,a,s){return function(r){var d,l,c,h,m,u,g,f=r.toJSON(),p=!1,v=e(document),w=e(s),y=w.find(".file-wrap"),C=w.find(".file-inset"),z=(w.find(".file-foot"),w.find(".file-controls")),k=new a,b=e('<p class="zoom"><a class="icon-btn zoom-in zoom-toggle-btn"></a></p>'),x=e('<div class="thumbnail-loading"></div>'),H=e('<p class="layers-toggle"><a class="icon-btn layers-toggle-btn"></a></p>'),M=t.utils.getCurrentBasePath(),P=/^#?link/.test(M),A=function(){var e={id:f.id,modified:f.modified,icon:f._defaultIcon,height:u||f.height,width:g||f.width,page:f._page,version:m?c.revision_number:f._version,versionHead:f._versionHead,layers:f._layers,type:f.type,name:f.name,link:f.linkId},i=function(e,i,t){u=t,g=i,O(e[0],e.attr("src"))};C.append(x),n(e,i)},O=function(e,i){if(i==l&&x.remove(),d)try{C.empty()}catch(t){}l=i,d=e,e.setAttribute("draggable",!1),C.empty().append(e).addClass("loaded"),b.off("click",I),z.append(b.on("click",I)),f.layer&&f.layer.layers.length>0&&H.off("click",S),R()},R=function(){if(!h)return void W.sizeChange();var i=60,o=250,n=t.utils.getViewport(),a=n.width<600?!0:!1,s=u||f.height,r=g||f.width,d=r/s,l=p?n.height:Math.max(o,h.height),c=p?n.width:h.width,m=c/l,v=e(".file-controls").outerHeight(!0)||26,z=e("#footer").outerHeight(!0);(r>=c-i||s+v>l-z)&&(m>d?(i+=e(".version-preview-menu").length?e(".version-preview-menu").outerHeight(!0):0,r=Math.floor((l-2*i)*d),s=l-2*i):(s=Math.floor((c-1.5*i)/d),r=c-1.5*i)),w.css({width:p?c:"auto",height:a&&!p?s+v:l}),y.css({width:r,height:s,top:P&&!p||a&&!p?0:Math.max(0,Math.floor((l-s)/2)-v)}),C.css({width:r,height:s})},I=function(t){var n=w.find(".zoom-toggle-btn"),a="link/",s=o.getCurrent();p=!p,p&&(s.indexOf(a)>-1?i("cca",{desc:"Maximize Public",assetid:r.id}):i("cca",{desc:"Maximize File",assetid:r.id})),t&&t.stopPropagation(),p?(e(document).on("keyup",function(e){27==e.keyCode&&I()}),w.addClass("file-media-zoom"),w.closest(".share-page").addClass("file-media-zoom"),n.removeClass("zoom-in").addClass("zoom-out"),w.prepend(n.remove()),H.hide(),v.on("click",I),C.on("click",J)):(e(document).off("keyup"),w.removeClass("file-media-zoom"),w.closest(".share-page").removeClass("file-media-zoom"),n.removeClass("zoom-out").addClass("zoom-in"),w.find("p.zoom").append(n.remove()),H.show(),v.unbind("click",I),C.off("click",J)),R(h)},J=function(e){e.preventDefault(),e.stopPropagation()},N=function(e){e.get("_version")===e.get("_versionHead")?(k.remove(),w.removeClass("preview-version")):(k.setResource(e),w.prepend(k.render().$el),w.addClass("preview-version"))},S=function(){w.find(".layers-toggle").toggleClass("active"),W.trigger("rendition.layers.toggle")},W={$el:w,show:function(){A()},hide:function(){e(".layers-container").removeClass("show-layers"),e(".control-container").show(),H.removeClass("active"),w.remove()},updateMetadata:function(e){r=e,f=r.toJSON(),c=_.where(f.revisions,{revision_number:f._version})[0],m="undefined"!=typeof c,c&&c.width&&c.height&&(u=f._isAutoRotated?c.width:c.height,g=f._isAutoRotated?c.height:c.width);var i=e.changed;i._version>=0&&N(e),_.keys(i).indexOf("shared")>-1||("empty"!==f._layers?A():C.empty())},sizeChange:function(){var i=e("#oneup-content").outerHeight(!0)||e(".cc-ActivityPlugin-imgframe").outerHeight(!0),t=e(".media").outerWidth(!0)||e(".cc-ActivityPlugin-imgframe").outerWidth(!0);h={height:i,width:t},R(h)}};return W=_.extend(e({}),W)}});